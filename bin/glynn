#!/usr/bin/env ruby
require 'rubygems'
require 'jekyll'
require 'glynn'
$:.unshift File.join(File.dirname(__FILE__), *%w[.. lib])


options = {}
case ARGV.size
  when 0
  when 1
    options['destination'] = ARGV[0]
  when 2
    options['source'] = ARGV[0]
    options['destination'] = ARGV[1]
end
options = Jekyll.configuration(options)


puts "Building site: #{options['source']} -> #{options['destination']}"
jekyll = Glynn::Jekyll.new
jekyll.build
puts "Successfully generated site"

puts "Sending site over FTP (host: #{options['ftp_host']})"
begin
  print "FTP Username: "
  username = $stdin.gets.chomp
  
  print "FTP Password: "
  # We hide the entered characters before to ask for the password
  system "stty -echo"
  password = $stdin.gets.chomp
  system "stty echo"
rescue NoMethodError, Interrupt
  # When the process is exited, we display the characters again
  # And we exit
  system "stty echo"
  exit
end

ftp = Glynn::Ftp.new(options['ftp_host'], 21, {:username => username, :password => password})
puts "\r\nConnected to server. Sending site"
ftp.sync(options['destination'], options['ftp_dir'])
puts "Successfully sent site"